@using Telerik.Web.Mvc.UI
@using System.Collections.Generic
@using BExIS.Modules.FMT.UI.Models

@model List<FMTMenuItem>

@{
    if (ViewBag.UseLayout == null)
    {
        Layout = null;
    }
}
<div>
 
    <div style="display:inline-block;width:20%;vertical-align: top;" class="overlay">

        @Html.ValidationMessage("Error")<br />
        @if (Model == null)
        {
           
        }
        else
        {
            @Html.Telerik().TreeView().Name("TreeView").ShowCheckBox(false).ExpandAll(true).ClientEvents(events => events
                                                       .OnSelect("onSelect").OnLoad("click_node")
                                                      ).BindTo(Model, mappings =>
                                                      {
                                                          mappings.For<FMTMenuItem>
                                                          (binding => binding.ItemDataBound((item, menuItem) =>
                                                          {
                                                              item.Text = menuItem.Title;
                                                              item.Value = menuItem.Path;
                                                              item.LinkHtmlAttributes["id"] = menuItem.Path.Replace("\\", "_");
                                                              item.ImageUrl = menuItem.MenuItems.Any() ? "~/Areas/FMT/Images/FMT_Images/Folders.png" : "~/Areas/FMT/Images/FMT_Images/Folder.png";
                                                          })
                                                              .Children(category => category.MenuItems));
                                                          mappings.For<FMTMenuItem>
                                                          (binding => binding
                                                          .ItemDataBound((item, subMenuItem) =>
                                                          {
                                                              item.Text = subMenuItem.Title;
                                                              item.Value = subMenuItem.Path;
                                                              item.LinkHtmlAttributes["id"] = subMenuItem.Path.Replace("\\","_");
                                                              item.ImageUrl = subMenuItem.MenuItems.Any() ? "~/Areas/FMT/Images/FMT_Images/Folders.png" : "~/Areas/FMT/Images/FMT_Images/Folder.png";
                                                          }));
                                                      });


        }

    </div>
    
    <div style="display:inline-block;width:80%;vertical-align: top;">
        <div id="current_path"></div>
        </br>
        <div style="width:100%" id="FMTFilesDIV"></div>
        <div style="width:100%" id="FMTFileUpload">

        </div>
    </div>
</div>
<script type="text/javascript">

    function treeView() {
        return $('#TreeView').data('tTreeView');
    }

    SelectedValue = '';

    function onSelect(e) {  
        var val = treeView().getItemValue(e.item);

        SelectedValue = val;
        loadFilesAndUploader();
    }
    function loadFilesAndUploader() {
        val = SelectedValue;
        contr = "InfoPage";
        $.get('@Url.Action("GetFileLists", "InfoPage", new { area=""})', { menuItemPath: val }, function (data) {
            $('#FMTFilesDIV').html(data);
        });
        $.get('@Url.Action("GetFileUploader", "InfoPageAdmin", new { area = "" })', { menuItemPath: val, cont: contr }, function (data) {
            $('#FMTFileUpload').html(data);
        });

        var current_path_arr = val.split('\\');

        var index;
        var current_path = "";
        var navigation_path = current_path_arr[0] + "__" + current_path_arr[2];
        for (index = 3; index < current_path_arr.length; ++index) {
            if (current_path_arr[index].length > 1) {
                navigation_path = navigation_path + "__" + current_path_arr[index];
                current_path = current_path + '  <b onclick="navigate_to_node(\'' + navigation_path  +'\');"> / ' + current_path_arr[index] + "</b>";
            }
        }

        $("#current_path").html(current_path);

    }

    jQuery.urlParam = function (name) {
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
        if (results == null) {
            return null;
        }
        return decodeURI(results[1]) || 0;
    }


    function click_node() {       
        jQuery("#" + jQuery.urlParam('node_id')).click();
    }

    function navigate_to_node(node_id) {
        console.log(node_id);
        jQuery("#" + node_id).click();
    }

</script>